---
- hosts: all
  become: true
  gather_facts: false
  vars_files:
    - "../vault/vault.yml"
  tasks:
    - name: copy server env file
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/.env_server"
      with_fileglob:
        - "../.env_server"

    - name: copy ui env file
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/.env_ui"
      with_fileglob:
        - "../.env_ui"

    - name: creation du fichier docker compose
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/docker-compose.preview-app.yml"
      with_fileglob:
        - "../docker-compose.preview-app.yml"

    - name: Build local images {{ pr_number }}
      shell: "bash /opt/bal/tools/build-branch-images.sh {{ git_revision }} {{ pr_number }} {{ status }}"
      register: results

    - debug:
        msg: "{{ item }}"
      loop: "{{ results.stdout_lines }}"
    - debug:
        msg: "{{ item }}"
      loop: "{{ results.stderr_lines }}"
