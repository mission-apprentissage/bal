---
- hosts: all
  become: true
  gather_facts: false
  vars_files:
    - "../vault/vault.yml"
  tasks:
    - name: copy docker env file
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/.env_docker_compose"
      with_fileglob:
        - "../.env_docker_compose"

    - name: copy server env file
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/.env_server"
      with_fileglob:
        - "../.env_server"

    - name: copy ui env file
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/.env_ui"
      with_fileglob:
        - "../.env_ui"

    - name: copy du fichier docker compose
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/docker-compose.yml"
      with_fileglob:
        - "../docker-compose.yml"

    - name: copy du fichier recette docker compose
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/opt/bal/docker-compose.recette.yml"
      with_fileglob:
        - "../docker-compose.recette.yml"
      when: env_type == 'recette'

    - name: Lancement de l'application {{env_type}}
      shell:
        chdir: /opt/bal
        cmd: "sudo env $(cat .env_docker_compose | xargs) docker stack deploy -c docker-compose.yml -c docker-compose.recette.yml bal"
      register: docker_deploy_output
      when: env_type == 'recette'

    - debug:
        var: docker_deploy_output

    - name: Lancement de l'application {{env_type}}
      shell:
        chdir: /opt/bal
        cmd: "sudo env $(cat .env_docker_compose | xargs) docker stack deploy -c docker-compose.yml bal"
      register: docker_deploy_output
      when: env_type == 'production'

    - debug:
        var: docker_deploy_output

    - name: Attente du deploiement
      shell:
        chdir: /opt/bal
        cmd: "sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock sudobmitch/docker-stack-wait bal"
      timeout: 900

    - name: migrations
      shell: "sudo bash /opt/bal/tools/run-migrations.sh"
      register: results
    - debug:
        msg: "{{ item }}"
      loop: "{{ results.stdout_lines }}"
