name: caching deps
on:
  workflow_dispatch:
jobs:
  caching:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        with:
          path: |
            node_modules
            ui/node_modules
            server/node_modules
            yarn.lock
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            /tmp/.build
          key: ${{ runner.os }}-deps-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ hashFiles('**/yarn.lock') }}

      - id: should-cache
        run: |
          if [ ! -d /tmp/.build ]
          then
            echo "build=yes" >> $GITHUB_OUTPUT
          else
            echo "build=no" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Build
        if: ${{ contains(steps.should-cache.outputs.build, 'yes') }}
        run: |
          docker build . -f "./Dockerfile.cache" --tag mna_bal_deps_installer:local \
          --label "org.opencontainers.image.source=https://github.com/mission-apprentissage/bal" \
          --label "org.opencontainers.image.licenses=MIT"
          mkdir -p /tmp/.build
          docker save -o /tmp/.build/mna_bal_deps_installer.tar mna_bal_deps_installer:local
        shell: bash

      # - name: Build
      #   if: ${{ contains(steps.should-cache.outputs.build, 'yes') }}
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     file: ./Dockerfile.cache
      #     tags: mna_bal_deps_installer:latest
      #     load: true
      #     cache-from: type=local,src=/tmp/.buildx-cache
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new
      #     labels: |
      #       org.opencontainers.image.source=https://github.com/mission-apprentissage/bal
      #       org.opencontainers.image.description=bal deps
      #       rg.opencontainers.image.licenses=MIT

      - name: load
        if: ${{ contains(steps.should-cache.outputs.build, 'no') }}
        run: |
          docker load -i /tmp/.build/mna_bal_deps_installer.tar
        shell: bash

      # - name: Move cache
      #   if: ${{ contains(steps.should-cache.outputs.build, 'yes') }}
      #   run: |
      #     rm -rf /tmp/.buildx-cache
      #     mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # - run: ls -l /tmp/.buildx-cache
      - run: docker run mna_bal_deps_installer:local
